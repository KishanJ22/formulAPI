name: Codacy Security Scan

on:
    pull_request:
        branches:
            - main
    workflow_run:
        workflows:
            - "Build and Test"
        types:
            - completed

jobs:
    codacy-security-scan:
        name: Codacy Security Scan
        runs-on: ubuntu-latest
        if: ${{ github.event.workflow_run.conclusion == 'success' }}
        steps:
            - name: Checkout code
              uses: actions/checkout@main

            - name: Run Codacy Analysis CLI
              uses: codacy/codacy-analysis-cli-action@v4.4.5
              with:
                  project-token: ${{ secrets.CODACY_PROJECT_TOKEN }}
                  api-token: ${{ secrets.CODACY_API_TOKEN }}
                  output: results.sarif
                  format: sarif
                  gh-code-scanning-compat: true
                  max-allowed-issues: 2147483647

            - name: Upload SARIF results file
              uses: github/codeql-action/upload-sarif@main
              with:
                  sarif_file: results.sarif
